{% extends "base.html" %}

{% block title %}Tìm kiếm{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>Tìm kiếm Bất Động Sản</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Bộ lọc tìm kiếm</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('search') }}" method="GET">
                    <div class="mb-3">
                        <label for="q" class="form-label">Từ khóa</label>
                        <input type="text" class="form-control" id="q" name="q" value="{{ search_term }}">
                    </div>
                    <div class="mb-3">
                        <label for="district" class="form-label">Quận/Huyện</label>
                        <select class="form-select" id="district" name="district">
                            <option value="">Tất cả</option>
                            <option value="Ba Đình" {% if selected_district == 'Ba Đình' %}selected{% endif %}>Ba Đình</option>
                            <option value="Cầu Giấy" {% if selected_district == 'Cầu Giấy' %}selected{% endif %}>Cầu Giấy</option>
                            <option value="Hoàn Kiếm" {% if selected_district == 'Hoàn Kiếm' %}selected{% endif %}>Hoàn Kiếm</option>
                            <option value="Hai Bà Trưng" {% if selected_district == 'Hai Bà Trưng' %}selected{% endif %}>Hai Bà Trưng</option>
                            <option value="Hoàng Mai" {% if selected_district == 'Hoàng Mai' %}selected{% endif %}>Hoàng Mai</option>
                            <option value="Đống Đa" {% if selected_district == 'Đống Đa' %}selected{% endif %}>Đống Đa</option>
                            <option value="Hà Đông" {% if selected_district == 'Hà Đông' %}selected{% endif %}>Hà Đông</option>
                            <option value="Tây Hồ" {% if selected_district == 'Tây Hồ' %}selected{% endif %}>Tây Hồ</option>
                            <option value="Long Biên" {% if selected_district == 'Long Biên' %}selected{% endif %}>Long Biên</option>
                            <option value="Nam Từ Liêm" {% if selected_district == 'Nam Từ Liêm' %}selected{% endif %}>Nam Từ Liêm</option>
                            <option value="Thanh Xuân" {% if selected_district == 'Thanh Xuân' %}selected{% endif %}>Thanh Xuân</option>
                            <option value="Đông Anh" {% if selected_district == 'Đông Anh' %}selected{% endif %}>Đông Anh</option>
                            <option value="Sóc Sơn" {% if selected_district == 'Sóc Sơn' %}selected{% endif %}>Sóc Sơn</option>
                            <option value="Gia Lâm" {% if selected_district == 'Gia Lâm' %}selected{% endif %}>Gia Lâm</option>
                            <option value="Thanh Trì" {% if selected_district == 'Thanh Trì' %}selected{% endif %}>Thanh Trì</option>
                            <option value="Mê Linh" {% if selected_district == 'Mê Linh' %}selected{% endif %}>Mê Linh</option>
                            <option value="Sơn Tây" {% if selected_district == 'Sơn Tây' %}selected{% endif %}>Sơn Tây</option>
                            <option value="Bắc Từ Liêm" {% if selected_district == 'Bắc Từ Liêm' %}selected{% endif %}>Bắc Từ Liêm</option>
                            <option value="Chương Mỹ" {% if selected_district == 'Chương Mỹ' %}selected{% endif %}>Chương Mỹ</option>
                            <option value="Ba Vì" {% if selected_district == 'Ba Vì' %}selected{% endif %}>Ba Vì</option>
                            <option value="Đan Phượng" {% if selected_district == 'Đan Phượng' %}selected{% endif %}>Đan Phượng</option>
                            <option value="Hoài Đức" {% if selected_district == 'Hoài Đức' %}selected{% endif %}>Hoài Đức</option>
                            <option value="Quốc Oai" {% if selected_district == 'Quốc Oai' %}selected{% endif %}>Quốc Oai</option>
                            <option value="Thạch Thất" {% if selected_district == 'Thạch Thất' %}selected{% endif %}>Thạch Thất</option>
                            <option value="Phúc Thọ" {% if selected_district == 'Phúc Thọ' %}selected{% endif %}>Phúc Thọ</option>
                            <option value="Thanh Oai" {% if selected_district == 'Thanh Oai' %}selected{% endif %}>Thanh Oai</option>
                            <option value="Ứng Hòa" {% if selected_district == 'Ứng Hòa' %}selected{% endif %}>Ứng Hòa</option>
                            <option value="Thường Tín" {% if selected_district == 'Thường Tín' %}selected{% endif %}>Thường Tín</option>
                            <option value="Phú Xuyên" {% if selected_district == 'Phú Xuyên' %}selected{% endif %}>Phú Xuyên</option>
                            <option value="Mỹ Đức" {% if selected_district == 'Mỹ Đức' %}selected{% endif %}>Mỹ Đức</option>
                            {% for district in districts %}
                            {% if district not in [
                                'Ba Đình','Cầu Giấy','Hoàn Kiếm','Hai Bà Trưng','Hoàng Mai','Đống Đa','Hà Đông','Tây Hồ','Long Biên','Nam Từ Liêm','Thanh Xuân',
                                'Đông Anh','Sóc Sơn','Gia Lâm','Thanh Trì','Mê Linh','Sơn Tây','Bắc Từ Liêm','Chương Mỹ','Ba Vì','Đan Phượng','Hoài Đức','Quốc Oai',
                                'Thạch Thất','Phúc Thọ','Thanh Oai','Ứng Hòa','Thường Tín','Phú Xuyên','Mỹ Đức'
                            ] %}
                            <!-- <option value="{{ district }}" {% if district == selected_district %}selected{% endif %}>{{ district }}</option> -->
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Khoảng giá (tỷ)</label>
                        <div class="row">
                            <div class="col">
                                <input type="number" class="form-control" name="price_min" placeholder="Từ" step="0.1" min="0" value="{{ request.args.get('price_min', '') }}">
                            </div>
                            <div class="col">
                                <input type="number" class="form-control" name="price_max" placeholder="Đến" step="0.1" min="0" value="{{ request.args.get('price_max', '') }}">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Diện tích (m²)</label>
                        <div class="row">
                            <div class="col">
                                <input type="number" class="form-control" name="area_min" placeholder="Từ" min="0" value="{{ request.args.get('area_min', '') }}">
                            </div>
                            <div class="col">
                                <input type="number" class="form-control" name="area_max" placeholder="Đến" min="0" value="{{ request.args.get('area_max', '') }}">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="bedrooms" class="form-label">Số phòng ngủ</label>
                        <select class="form-select" id="bedrooms" name="bedrooms">
                            <option value="">Tất cả</option>
                            {% for i in range(1, 6) %}
                            <option value="{{ i }}" {% if request.args.get('bedrooms') == i|string %}selected{% endif %}>{{ i }}+</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i>Tìm kiếm
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        {% if properties %}
            <div class="alert alert-info">
                Tìm thấy {{ total_properties }} kết quả cho "{{ search_term }}"
            </div>

            <div class="row">
                {% for property in properties %}
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">{{ property.title }}</h5>
                            <p class="card-text">
                                <strong>ID:</strong> {{ property.house_id }}<br>
                                <strong>Quận/Huyện:</strong> {{ property.district }}<br>
                                <strong>Giá:</strong> {{ property.price }}<br>
                                <strong>Diện tích:</strong> {{ property.area }} m²<br>
                                <strong>Phòng ngủ:</strong> {{ property.bedrooms }}<br>
                                <strong>Phòng tắm:</strong> {{ property.bathrooms }}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="{{ url_for('property_details', house_id=property.house_id) }}" class="btn btn-primary">Xem chi tiết</a>
                                {% if not session.get('is_admin', False) %}
                                <a href="{{ url_for('deposit', house_id=property.house_id) }}" class="btn btn-warning ms-2">Đặt cọc</a>
                                {% endif %}
                                {% if session.get('user_id') %}
                                <form action="{{ url_for('add_favorite', house_id=property.house_id) }}" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-outline-danger" title="Yêu thích">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if current_page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('search', q=search_term, page=current_page-1, per_page=per_page) }}">
                            Trước
                        </a>
                    </li>
                    {% endif %}

                    {% for i in range(1, total_pages + 1) %}
                    <li class="page-item {% if i == current_page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('search', q=search_term, page=i, per_page=per_page) }}">
                            {{ i }}
                        </a>
                    </li>
                    {% endfor %}

                    {% if current_page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('search', q=search_term, page=current_page+1, per_page=per_page) }}">
                            Sau
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        {% else %}
            <div class="alert alert-info">Không tìm thấy kết quả nào cho "{{ search_term }}"</div>
        {% endif %}
    </div>
</div>
{% endblock %}